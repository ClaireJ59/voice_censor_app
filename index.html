<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI èªéŸ³æ·¨åŒ–å™¨ (Censor)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 85%;
            max-width: 400px;
        }
        h1 { color: #333; margin-bottom: 2rem; font-size: 1.5rem; }
        
        /* éŒ„éŸ³æŒ‰éˆ•æ¨£å¼ */
        #recordBtn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ff4757;
            border: none;
            box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        
        #recordBtn.recording {
            animation: pulse 1.5s infinite;
            background-color: #ff6b81;
            border-radius: 20%; /* è®Šå½¢æˆæ–¹å½¢è¡¨ç¤ºåœæ­¢ */
        }

        #recordBtn svg { width: 40px; height: 40px; fill: white; }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { transform: scale(1.0); box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        #status { margin-top: 20px; color: #666; font-weight: 500; min-height: 1.2em;}
        
        /* æ’­æ”¾å™¨ */
        audio { width: 100%; margin-top: 20px; display: none; }
        
        /* ä¸‹è¼‰æŒ‰éˆ• */
        #downloadLink {
            display: none;
            margin-top: 15px;
            color: #2ed573;
            text-decoration: none;
            font-weight: bold;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ™ï¸ AI èªéŸ³æ·¨åŒ–å™¨</h1>
    
    <button id="recordBtn">
        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
    </button>
    
    <p id="status">é»æ“Šé–‹å§‹éŒ„éŸ³</p>
    
    <div class="loader" id="loader"></div>
    
    <audio id="audioPlayer" controls></audio>
    <a id="downloadLink" href="#" download="censored_audio.mp3">ä¸‹è¼‰éŸ³æª”</a>
</div>

<script>
    // ==========================================
    // ğŸš¨ è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ n8n Webhook ç¶²å€
    // ==========================================
    const WEBHOOK_URL = "https://claire-n8n.onrender.com/webhook-test/e8840ada-9e4a-41c9-b3f1-65c80b816333"; 
    // ==========================================

    let mediaRecorder;
    let audioChunks = [];
    const recordBtn = document.getElementById('recordBtn');
    const status = document.getElementById('status');
    const audioPlayer = document.getElementById('audioPlayer');
    const loader = document.getElementById('loader');
    const downloadLink = document.getElementById('downloadLink');
    let isRecording = false;

    // 1. è™•ç†éŒ„éŸ³é»æ“Š
    recordBtn.addEventListener('click', async () => {
        if (!isRecording) {
            startRecording();
        } else {
            stopRecording();
        }
    });

    // 2. é–‹å§‹éŒ„éŸ³
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream); // ç€è¦½å™¨æœƒè‡ªå‹•é¸æ“‡æ”¯æ´çš„æ ¼å¼ (é€šå¸¸æ˜¯ webm æˆ– mp4)
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = sendAudioToN8n;

            mediaRecorder.start();
            isRecording = true;
            recordBtn.classList.add('recording');
            status.innerText = "éŒ„éŸ³ä¸­... (é»æ“Šåœæ­¢)";
            audioPlayer.style.display = 'none';
            downloadLink.style.display = 'none';
        } catch (err) {
            alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®šï¼š" + err);
        }
    }

    // 3. åœæ­¢éŒ„éŸ³
    function stopRecording() {
        mediaRecorder.stop();
        isRecording = false;
        recordBtn.classList.remove('recording');
        status.innerText = "è™•ç†ä¸­ï¼Œè«‹ç¨å€™...";
        loader.style.display = 'block';
    }

    // 4. ç™¼é€è‡³ n8n (æ ¸å¿ƒé‚è¼¯)
    async function sendAudioToN8n() {
        // å»ºç«‹ Blob (éŸ³è¨Šæª”æ¡ˆ)
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        
        // æº–å‚™ JSON (Base64) å‚³è¼¸æ¨¡å¼ - ç‚ºäº†é…åˆæˆ‘å€‘ä¹‹å‰çš„ Colab é‚è¼¯
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob); 
        
        reader.onloadend = async function() {
            // ç§»é™¤å‰ç«¯çš„ "data:audio/webm;base64," æ¨™é ­ï¼Œåªç•™ç´” Base64
            const base64String = reader.result.split(',')[1];

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base64_audio_content: base64String
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                // 5. æ¥æ”¶å›å‚³çš„ MP3 (Blob)
                const responseBlob = await response.blob();
                const audioUrl = URL.createObjectURL(responseBlob);
                
                // æ’­æ”¾
                audioPlayer.src = audioUrl;
                audioPlayer.style.display = 'block';
                
                // è¨­å®šä¸‹è¼‰é€£çµ
                downloadLink.href = audioUrl;
                downloadLink.style.display = 'block';
                
                status.innerText = "âœ… è™•ç†å®Œæˆï¼";
            } catch (error) {
                status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤";
                alert("ä¸Šå‚³å¤±æ•—: " + error.message);
                console.error(error);
            } finally {
                loader.style.display = 'none';
            }
        };
    }
</script>

</body>
</html>
